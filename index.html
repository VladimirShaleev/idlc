<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDL Compiler</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #editor {
            width: 100%;
            height: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            margin-bottom: 10px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 0;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-top: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
            background: white;
            height: 300px;
            overflow-y: auto;
        }
        .tab-content.active {
            display: block;
        }
        .filename {
            font-weight: bold;
            margin-bottom: 10px;
        }
        pre {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            margin: 0;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
        }
        .warning {
            background-color: #fcf8f2;
            color: #f0ad4e;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>IDL Compiler</h1>
        <textarea id="editor" placeholder="Enter your IDL code here..."></textarea>
        <button id="compile">Compile</button>
        <div id="status" class="status" style="display: none;"></div>
        
        <div class="tabs" id="tabs-container"></div>
        <div id="tab-contents"></div>
    </div>

    <script type="module">
        import idlc from './idlc.js'

        const module = await idlc();

        const editor = document.getElementById('editor');
        const compileBtn = document.getElementById('compile');
        const tabsContainer = document.getElementById('tabs-container');
        const tabContents = document.getElementById('tab-contents');
        const statusDiv = document.getElementById('status');

        editor.value = `@ API Sample
@ Demonstration of the .idl file for describing the library interface [detail]
@ Author <author@mail.org> [author]
@ MIT License [copyright]
api Sample [version(1,1,0)]

@ Logging severity levels.
@ Hierarchical message importance classification. [detail]
enum LoggerLevel
    const Verbose @ Detailed diagnostic messages.
    const Debug   @ Debugging information.
    const Info    @ Informational messages.
    const Warning @ Potentially problematic situations.
    const Error   @ Recoverable error conditions.
    const Fatal   @ Critical unrecoverable errors.
    const Off     @ No logging output.

@ Graphics features.
@ Bitmask of supported hardware capabilities. [detail]
@ Sample ref {LoggerLevel}. [see]
enum Feature [flags]
    const None : 0 @ No special features
    const Bindless : 1 @ Bindless resource access
    const GeometryShader : 2 @ Geometry shader support
    const MeshShader : 4 @ Mesh shader support
    const SamplerFilterMinmax : 8 @ Min/max sampler filtering
    const DrawIndirect : 16 @ Indirect drawing

@ Color clear values.
@ Specifies RGBA values for color attachment clearing. [detail]
struct Color
    field Red {Float32} @ Red channel clear value.
    field Green {Float32} @ Green channel clear value.
    field Blue {Float32} @ Blue channel clear value.
    field Alpha {Float32} @ Alpha channel clear value.

@ Ger version lib
@ Format: (major << 16) | (minor << 8) | micro. [detail]
@ Return packed version number of "{Major}.{Minor}.{Micro}"[return]
func Version {Uint32}

@ Logging system interface.
@ Provides logging facilities with multiple severity levels. [detail]
interface Logger
    prop Level [get(GetLevel),set(SetLevel)] @ Current log severity threshold.

    @ Creates new logger instance
    @ Initializes logging subsystem with specific tag. [detail]
    @ Operation result [return]
    @ The tag string is specified in the format: "mygame:logic:health". [note]
    method Create {Bool} [ctor]
        arg Tag {Str} @ Tag string.
        arg Logger {Logger} [result] @ New logger instance.

    @ Releases logger instance.
    @ Destroys when reference count reaches zero. [detail]
    method Destroy [destroy]
        arg Logger {Logger} [this] @ Logger to destroy.

    @ Gets current severity level.
    @ Returns minimum level for logged messages. [detail]
    @ Current severity threshold. [return]
    @ {SetLevel} [see]
    method GetLevel {LoggerLevel} [const]
        arg Logger {Logger} [this] @ Target logger.

    @ Sets logging severity level.
    @ Filters messages below specified level. [detail]
    @ {GetLevel} [see]
    method SetLevel
        arg Logger {Logger} [this] @ Target logger.
        arg Level {LoggerLevel} @ New severity threshold.
`;

        compileBtn.addEventListener('click', () => {
            const code = editor.value.trim();
            if (!code) {
                clearStatus();
                showStatus('Please enter some code to compile', 'error');
                return;
            }

            const result = compileCode(code); 
            if (Object.keys(result).length !== 0) {
                showResults(result);
            }
        });

        function compileCode(code) {
            clearStatus();
            showStatus('Compiling...');

            const results = {};

            const options = new module.Options();
            options.debugMode = false;
            // options.warningsAsErrors = true;
            // options.setVersion({major: 1, minor: 2, micro: 0});
            options.setWriter(function(source) {
                results[source.name] = source.data;
            });

            const source1 = new module.Source;
            source1.name = "<input>";
            source1.data = code;

            const compiler = new module.Compiler;
            const result = compiler.compile(module.Generator.C, undefined, [ source1 ], options);
            
            clearStatus();
            var failed = false;
            result.messages.forEach(message => {
                const isWarning = message.status.value < 2000 && !options.warningsAsErrors;
                if (!isWarning) {
                    failed = true;
                }
                showStatus(`${isWarning ? "waring" : "error"} [${message.status.value < 2000 ? "W" : "E"}${message.status.value}]: ${message.message} at ${message.filename}:${message.line}:${message.column}`, isWarning ? 'warning' : 'error')
            });

            if (failed) {
                showStatus('Compilation failed', 'error');
            } else {
                showStatus('Compilation successful!', 'success');
            }

            result.delete();
            compiler.delete();
            options.delete();

            return results;
        }

        function showResults(files) {
            tabsContainer.innerHTML = '';
            tabContents.innerHTML = '';
            
            let first = true;
            for (const [filename, content] of Object.entries(files)) {
                const tab = document.createElement('div');
                tab.className = `tab ${first ? 'active' : ''}`;
                tab.textContent = filename;
                tab.addEventListener('click', () => switchTab(filename));
                tabsContainer.appendChild(tab);
                
                const contentDiv = document.createElement('div');
                contentDiv.className = `tab-content ${first ? 'active' : ''}`;
                contentDiv.id = `tab-${filename}`;
                contentDiv.innerHTML = `
                    <pre>${escapeHtml(content)}</pre>
                `;
                tabContents.appendChild(contentDiv);
                
                first = false;
            }
        }

        function switchTab(filename) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const tabs = document.querySelectorAll('.tab');
            const targetTab = Array.from(tabs).find(tab => 
                tab.textContent.trim() === filename
            );
            
            if (targetTab) {
                targetTab.classList.add('active');
                document.getElementById(`tab-${filename}`)?.classList.add('active');
            }
        }

        function showStatus(message, type = '') {
            const messageElement = document.createElement('div');
            messageElement.className = `status ${type}`;
            messageElement.textContent = message;
    
            statusDiv.style.display = 'block';
            statusDiv.appendChild(messageElement);
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }
                
        function clearStatus() {
            statusDiv.innerHTML = '';
            statusDiv.style.display = 'none';
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        document.querySelectorAll('.tab').forEach(tab => {
            tab.matches = tab.matches || 
                tab.msMatchesSelector || 
                tab.webkitMatchesSelector;
        });
    </script>
</body>
</html>
